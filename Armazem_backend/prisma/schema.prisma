generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StockRole {
  ADMIN
  MEMBER
}

enum AccessStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AgendamentoStatus {
  PENDING
  SENT
  EXECUTED
  CANCELED
  FAILED
}

enum AlertaTipo {
  ABAIXO_MINIMO
  RUPTURA
  EXCESSO
}

enum RastreioTipo {
  NONE
  LOTE
  SERIAL
}

enum AbcClasses {
  A
  B
  C
}

enum CountStatus {
  PENDING
  IN_PROGRESS
  RECOUNT_REQUIRED
  CLOSED
  CANCELED
}

enum DiscrepancyResolution {
  WITHIN_TOLERANCE
  ADJUSTED
  RECOUNT_CLOSED
}

enum LogType {
  ACCESS
  INVENTORY
  BOT
}

enum LogAction {
  LOGIN
  LOGOUT
  REQUEST
  CREATE
  UPDATE
  DELETE
  MOVE
  TRANSFER
  MESSAGE_SENT
  MESSAGE_FAILED
}

model Usuario {
  id    Int     @id @default(autoincrement())
  nome  String? @db.VarChar(255)
  email String  @unique @db.VarChar(255)
  senha String? @db.VarChar(255)

  roles              UsuarioRole[]
  estoques           UsuarioEstoque[]
  passwordResetToken PasswordResetToken[]
  notificacoes       Notificacao[]
  agendamentos       TransferenciaAgendada[]
  transferencias     Transferencia[]

  estoqueTelegramNotify EstoqueTelegramNotify[]
  accessRequests        StockAccessRequest[]    @relation("RequestOwner")
  approvedRequests      StockAccessRequest[]    @relation("StockRequestApprover")
  cookies               Ciente_cookies[]

  @@map("usuarios")
}

model Ciente_cookies {
  id      Int     @id @default(autoincrement())
  userId  Int
  ciencia Boolean

  user Usuario @relation(fields: [userId], references: [id])
}

model Equipamento {
  id             Int           @id @default(autoincrement())
  nome           String?       @map("equipamento") @db.VarChar(255)
  quantidade     Int?
  data           DateTime?     @db.Date
  rastreioTipo   RastreioTipo  @default(NONE)
  
  transferencias Transferencia[]
  estoqueItens   EstoqueItem[]
  agendamentos   TransferenciaAgendada[]
  contagemTarefa ContagemCiclicaTarefa[]
  lotes          Lote[]
  seriais        Serial[]
  movimentos     MovEstoque[]

  deletedAt      DateTime?

  @@map("equipamentos")
}


model Lote {
  id        Int       @id @default(autoincrement())
  itemId    Int
  codigo    String
  validade  DateTime? @db.Date
  createdAt DateTime  @default(now())

  contagemTarefa ContagemCiclicaTarefa[]
  item           Equipamento             @relation(fields: [itemId], references: [id], onDelete: Restrict)
  seriais        Serial[]
  movimentos     MovEstoque[]

  @@unique([itemId, codigo], name: "unique_lote_por_item")
  @@index([itemId, validade])
  @@map("lotes")
}

model Serial {
  id        Int      @id @default(autoincrement())
  itemId    Int
  numero    String   @unique
  loteId    Int?
  createdAt DateTime @default(now())

  contagemTarefa ContagemCiclicaTarefa[]
  item           Equipamento             @relation(fields: [itemId], references: [id], onDelete: Restrict)
  lote           Lote?                   @relation(fields: [loteId], references: [id], onDelete: SetNull)

  movimentos MovEstoque[]

  @@index([itemId, loteId])
  @@map("seriais")
}

model MovEstoque {
  id               Int      @id @default(autoincrement())
  itemId           Int
  loteId           Int?
  serialId         Int?
  estoqueOrigemId  Int?
  estoqueDestinoId Int?
  quantidade       Int
  tipoEvento       String
  referenciaTabela String?
  referenciaId     Int?
  createdAt        DateTime @default(now())

  item    Equipamento @relation(fields: [itemId], references: [id], onDelete: Restrict)
  lote    Lote?       @relation(fields: [loteId], references: [id], onDelete: Restrict)
  serial  Serial?     @relation(fields: [serialId], references: [id], onDelete: Restrict)
  origem  Estoque?    @relation("MovOrigem", fields: [estoqueOrigemId], references: [id], onDelete: Restrict)
  destino Estoque?    @relation("MovDestino", fields: [estoqueDestinoId], references: [id], onDelete: Restrict)

  @@index([itemId, loteId, serialId])
  @@index([estoqueOrigemId])
  @@index([estoqueDestinoId])
  @@map("mov_estoque")
}

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user Usuario @relation(fields: [userId], references: [id])

  @@unique([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Estoque {
  id   Int    @id @default(autoincrement())
  nome String @db.VarChar(100)

  transferenciasDestino Transferencia[] @relation("TransferenciasDestino")
  transferenciasOrigem  Transferencia[] @relation("TransferenciasOrigem")
  itens                 EstoqueItem[]

  agendamentosOrigem  TransferenciaAgendada[] @relation("AgendamentoOrigem")
  agendamentosDestino TransferenciaAgendada[] @relation("AgendamentoDestino")

  movimentosOrigem  MovEstoque[] @relation("MovOrigem")
  movimentosDestino MovEstoque[] @relation("MovDestino")

  contagemTarefa        ContagemCiclicaTarefa[]
  contagemCiclica       ContagemCiclicaPolitica[]
  usuarios              UsuarioEstoque[]
  estoqueTelegramNotify EstoqueTelegramNotify[]
  requests              StockAccessRequest[]

  @@map("estoques")
}

model UsuarioEstoque {
  usuarioId Int
  estoqueId Int

  role      StockRole @default(MEMBER)

  roleId    Int?
  roleRef   Role?     @relation(fields: [roleId], references: [id]) // nomeei roleRef só p/ não colidir

  usuario   Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  estoque   Estoque   @relation(fields: [estoqueId], references: [id], onDelete: Cascade)

  @@id([usuarioId, estoqueId])
  @@map("usuarios_estoques")
}


model Notificacao {
  id        Int       @id @default(autoincrement())
  userId    Int
  type      String
  title     String
  message   String
  refId     Int?
  readAt    DateTime?
  createdAt DateTime  @default(now())

  usuario Usuario @relation(fields: [userId], references: [id])
}

model StockAccessRequest {
  id         Int          @id @default(autoincrement())
  estoqueId  Int
  usuarioId  Int
  status     AccessStatus @default(PENDING)
  reason     String?      @db.VarChar(255)
  approverId Int?
  decidedAt  DateTime?
  createdAt  DateTime     @default(now())

  estoque  Estoque  @relation(fields: [estoqueId], references: [id], onDelete: Cascade)
  usuario  Usuario  @relation("RequestOwner", fields: [usuarioId], references: [id], onDelete: Cascade)
  approver Usuario? @relation("StockRequestApprover", fields: [approverId], references: [id])

  @@unique([estoqueId, usuarioId, status], name: "unique_pending_per_user_stock_status")
}

model Transferencia {
  id                Int       @id @default(autoincrement())
  itemId            Int
  estoqueOrigemId   Int
  estoqueDestinoId  Int
  quantidade        Int
  dataTransferencia DateTime? @default(now()) @db.Timestamptz(6)

  usuarioId   Int?
  usuario     Usuario?               @relation(fields: [usuarioId], references: [id])
  agendamento TransferenciaAgendada?

  item    Equipamento @relation(fields: [itemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  origem  Estoque     @relation("TransferenciasOrigem", fields: [estoqueOrigemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  destino Estoque     @relation("TransferenciasDestino", fields: [estoqueDestinoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([usuarioId])
  @@map("transferencias")
}

model EstoqueItem {
  id                Int         @id @default(autoincrement())
  estoqueId         Int
  itemId            Int
  quantidade        Int         @default(0)
  minimo            Int         @default(0)
  maximo            Int?
  multiplo          Int?
  alertaativo       Boolean     @default(false)
  autoAtivo         Boolean     @default(false)
  origemPreferidaId Int?
  leadTimeDias      Int?
  classeAbc         AbcClasses?
  lastCountedAt     DateTime?
  nextCountDueAt    DateTime?

  estoque Estoque         @relation(fields: [estoqueId], references: [id])
  item    Equipamento     @relation(fields: [itemId], references: [id])
  alertas AlertaEstoque[]

  @@unique([itemId, estoqueId], name: "itemId_estoqueId")
  @@map("estoque_itens")
}

model AlertaEstoque {
  id            Int        @id @default(autoincrement())
  estoqueId     Int
  itemId        Int
  tipo          AlertaTipo
  mensagem      String
  resolvido     Boolean    @default(false)
  createdAt     DateTime   @default(now())
  resolvedAt    DateTime?
  ultimoEnvioAt DateTime?

  estoqueItem EstoqueItem @relation(fields: [itemId, estoqueId], references: [itemId, estoqueId])

  @@index([estoqueId, itemId, resolvido])
  @@map("alertas_estoque")
}

model Role {
  id   Int    @id @default(autoincrement())
  nome String @unique @db.VarChar(50)

  usuarios        UsuarioRole[]
  perms           RolePerm[]
  rotasPermitidas PermissaoOnRoute[]
  usuarioEstoque  UsuarioEstoque[]

  @@map("permissoes")
}

model UsuarioRole {
  usuarioId Int @map("usuarioId")
  roleId    Int @map("permissaoId")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  role    Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([usuarioId, roleId])
  @@map("usuarios_permissoes")
}

model Permission {
  id   Int     @id @default(autoincrement())
  code String  @unique
  desc String?

  roles RolePerm[]

  @@map("permissions")
}

model RolePerm {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("roles_permissions")
}

model Route {
  id         Int                @id @default(autoincrement())
  nome       String
  path       String
  permissoes PermissaoOnRoute[]
  createdAt  DateTime           @default(now())
  // @@map("routes")
}

model PermissaoOnRoute {
  id          Int @id @default(autoincrement())
  permissaoId Int
  routeId     Int

  permissao Role  @relation(fields: [permissaoId], references: [id])
  route     Route @relation(fields: [routeId], references: [id])
}

model EstoqueTelegramNotify {
  id        Int      @id @default(autoincrement())
  usuarioId Int?
  estoqueId Int
  chatId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  estoque Estoque  @relation(fields: [estoqueId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, estoqueId], name: "usuario_estoque_unique")
  @@index([estoqueId])
}

model TransferenciaAgendada {
  id               Int      @id @default(autoincrement())
  itemId           Int
  estoqueOrigemId  Int
  estoqueDestinoId Int
  quantidade       Int
  usuarioId        Int
  executarEm       DateTime @db.Timestamptz(6)

  status              AgendamentoStatus @default(PENDING)
  tentativas          Int               @default(0)
  erroUltimaTentativa String?

  origemTipo String?
  motivo     String?
  dedupKey   String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transferenciaId Int?           @unique
  transferencia   Transferencia? @relation(fields: [transferenciaId], references: [id])

  item    Equipamento @relation(fields: [itemId], references: [id], onDelete: Restrict)
  origem  Estoque     @relation("AgendamentoOrigem", fields: [estoqueOrigemId], references: [id], onDelete: Restrict)
  destino Estoque     @relation("AgendamentoDestino", fields: [estoqueDestinoId], references: [id], onDelete: Restrict)
  usuario Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Restrict)

  @@index([status, executarEm])
  @@index([usuarioId])
  @@index([itemId, estoqueOrigemId, estoqueDestinoId])
  @@map("transferencias_agendadas")
}

model MovimentacaoEstoque {
  id           Int      @id @default(autoincrement())
  itemId       Int
  estoqueId    Int
  tipo         String
  quantidade   Int
  referenciaId Int?
  createdAt    DateTime @default(now())
}

model ContagemCiclicaPolitica {
  id             Int         @id @default(autoincrement())
  estoqueId      Int
  itemId         Int?
  classeAbc      AbcClasses?
  frequenciaDias Int
  toleranciaPct  Float
  contagemDupla  Boolean     @default(true)
  bloquearMov    Boolean     @default(true)
  ativa          Boolean     @default(true)

  contagemTarefa ContagemCiclicaTarefa[]
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt

  estoque Estoque @relation(fields: [estoqueId], references: [id])

  @@unique([estoqueId, itemId, classeAbc], name: "politica_scope_unique")
  @@index([estoqueId, ativa])
  @@index([classeAbc])
  @@map("contagem_politicas")
}

model ContagemCiclicaTarefa {
  id            Int         @id @default(autoincrement())
  estoqueId     Int
  itemId        Int
  loteId        Int?
  serialId      Int?
  status        CountStatus @default(PENDING)
  dueAt         DateTime
  startedAt     DateTime?
  closedAt      DateTime?
  cancelReason  String?     @db.VarChar(255)
  politicaId    Int?
  toleranciaPct Float?
  contagemDupla Boolean?
  bloquearMov   Boolean?

  systemQtyAtStart Int?
  finalQty         Int?
  resolution       DiscrepancyResolution?
  ajusteMovId      Int?

  createdById Int?
  closedById  Int?

  estoque     Estoque                     @relation(fields: [estoqueId], references: [id])
  item        Equipamento                 @relation(fields: [itemId], references: [id])
  lote        Lote?                       @relation(fields: [loteId], references: [id])
  serial      Serial?                     @relation(fields: [serialId], references: [id])
  politica    ContagemCiclicaPolitica?    @relation(fields: [politicaId], references: [id])
  lancamentos ContagemCiclicaLancamento[]

  @@index([estoqueId, itemId, status, dueAt])
  @@map("contagem_tarefas")
}

model ContagemCiclicaLancamento {
  id           Int      @id @default(autoincrement())
  tarefaId     Int
  tentativa    Int
  quantidade   Int
  contadoPorId Int?
  contadoEm    DateTime @default(now())

  tarefa ContagemCiclicaTarefa @relation(fields: [tarefaId], references: [id])

  @@unique([tarefaId, tentativa])
  @@index([contadoEm])
  @@map("contagem_lancamentos")
}

model LogEvent {
  id              String    @id @default(uuid()) @db.Uuid
  type            LogType
  action          LogAction
  success         Boolean   @default(true)
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  actorUserId     String?   @db.Uuid
  actorName       String?
  ip              String?
  userAgent       String?
  httpMethod      String?
  route           String?
  correlationId   String?
  message         String?
  errorCode       String?
  errorMessage    String?
  itemId          Int?
  estoqueId       Int?
  transferenciaId Int?
  botMessageId    String?
  botChatId       String?

  metadata Json? @db.JsonB

  @@index([type, action, createdAt])
  @@index([createdAt])
  @@index([actorUserId, createdAt])
  @@index([itemId, createdAt])
  @@index([estoqueId, createdAt])
  @@index([route, createdAt])

  @@map("log_event")
}
