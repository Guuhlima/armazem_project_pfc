generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StockRole {
  ADMIN
  MEMBER
}

enum AccessStatus {
  PENDING
  APPROVED
  REJECTED
}

model Usuario {
  id        Int     @id @default(autoincrement())
  nome      String? @db.VarChar(255)
  email     String  @unique @db.VarChar(255)
  matricula Int?
  senha     String? @db.VarChar(255)

  roles              UsuarioRole[]
  estoques           UsuarioEstoque[]
  passwordResetToken PasswordResetToken[]
  notificacoes       Notificacao[]
  
  accessRequests   StockAccessRequest[] @relation("RequestOwner")
  approvedRequests StockAccessRequest[] @relation("StockRequestApprover")

  @@map("usuarios")
}

model Equipamento {
  id             Int             @id @default(autoincrement())
  nome           String?         @map("equipamento") @db.VarChar(255)
  quantidade     Int?
  data           DateTime?       @db.Date
  transferencias Transferencia[]
  estoqueItens   EstoqueItem[]

  @@map("equipamentos")
}

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user Usuario @relation(fields: [userId], references: [id])

  @@unique([tokenHash])
  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Estoque {
  id   Int    @id @default(autoincrement())
  nome String @db.VarChar(100)

  transferenciasDestino Transferencia[] @relation("TransferenciasDestino")
  transferenciasOrigem  Transferencia[] @relation("TransferenciasOrigem")
  itens                 EstoqueItem[]

  usuarios UsuarioEstoque[]

  requests StockAccessRequest[]

  @@map("estoques")
}

model UsuarioEstoque {
  usuarioId Int
  estoqueId Int
  role      StockRole @default(MEMBER)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  estoque Estoque @relation(fields: [estoqueId], references: [id], onDelete: Cascade)

  @@id([usuarioId, estoqueId])
  @@map("usuarios_estoques")
}

model Notificacao {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String
  title     String
  message   String
  refId     Int?
  readAt    DateTime?
  createdAt DateTime @default(now())

  usuario   Usuario  @relation(fields: [userId], references: [id])
}

model StockAccessRequest {
  id         Int          @id @default(autoincrement())
  estoqueId  Int
  usuarioId  Int
  status     AccessStatus @default(PENDING)
  reason     String?      @db.VarChar(255)
  approverId Int?
  decidedAt  DateTime?
  createdAt  DateTime     @default(now())

  estoque  Estoque  @relation(fields: [estoqueId], references: [id], onDelete: Cascade)
  usuario  Usuario  @relation("RequestOwner", fields: [usuarioId], references: [id], onDelete: Cascade)
  approver Usuario? @relation("StockRequestApprover", fields: [approverId], references: [id])

  @@unique([estoqueId, usuarioId, status], name: "unique_pending_per_user_stock_status")
}

model Transferencia {
  id                Int       @id @default(autoincrement())
  itemId            Int
  estoqueOrigemId   Int
  estoqueDestinoId  Int
  quantidade        Int
  dataTransferencia DateTime? @default(now()) @db.Timestamp(6)

  item    Equipamento @relation(fields: [itemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  origem  Estoque     @relation("TransferenciasOrigem", fields: [estoqueOrigemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  destino Estoque     @relation("TransferenciasDestino", fields: [estoqueDestinoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("transferencias")
}

model EstoqueItem {
  id         Int @id @default(autoincrement())
  estoqueId  Int
  itemId     Int
  quantidade Int

  estoque Estoque     @relation(fields: [estoqueId], references: [id])
  item    Equipamento @relation(fields: [itemId], references: [id])

  @@unique([itemId, estoqueId], name: "itemId_estoqueId")
  @@map("estoque_itens")
}

model Role {
  id   Int    @id @default(autoincrement())
  nome String @unique @db.VarChar(50)

  usuarios        UsuarioRole[]
  perms           RolePerm[]
  rotasPermitidas PermissaoOnRoute[]

  @@map("permissoes")
}

model UsuarioRole {
  usuarioId Int @map("usuarioId")
  roleId    Int @map("permissaoId")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  role    Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([usuarioId, roleId])
  @@map("usuarios_permissoes")
}

model Permission {
  id   Int     @id @default(autoincrement())
  code String  @unique
  desc String?

  roles RolePerm[]

  @@map("permissions")
}

model RolePerm {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("roles_permissions")
}

model Route {
  id         Int                @id @default(autoincrement())
  nome       String
  path       String
  permissoes PermissaoOnRoute[]
  createdAt  DateTime           @default(now())
  // @@map("routes") se sua tabela tiver nome diferente
}

model PermissaoOnRoute {
  id          Int @id @default(autoincrement())
  permissaoId Int
  routeId     Int

  permissao Role  @relation(fields: [permissaoId], references: [id])
  route     Route @relation(fields: [routeId], references: [id])
}
